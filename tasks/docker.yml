---
- name: install recommended extra packages
  become: True
  apt:
    name: "{{item}}"
    state: present
  with_items:
  - curl
  - apt-transport-https
  - ca-certificates

- name: add docker apt key
  become: True
  apt_key:
    data: "{{ lookup('file', '../files/docker-apt-key') }}"
    state: present

- name: gather facts to have access to ansible_distribution_release
  setup:
  when: ansible_distribution_release is undefined

- name: add docker apt repository
  become: True
  apt_repository:
    repo: deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ansible_distribution_release}} stable
    update_cache: True

- name: install docker engine
  become: True
  apt:
    name: docker-ce={{docker_version}}

- name: add {{item}} to docker group
  become: True
  user:
    name: "{{item}}"
    groups: docker
    append: True
  with_items: "{{docker_users}}"
  when: docker_users is defined

- name: create the docker systemd directory
  become: True
  file:
    path: /etc/systemd/system/docker.service.d
    state: directory
